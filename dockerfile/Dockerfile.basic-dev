ARG UBUNTU_VERSION=22.04
# PYTHON_VERSION can be explicitly set or auto-detected from UBUNTU_VERSION:
# Ubuntu 22.04 -> Python 3.10
# Ubuntu 24.04 -> Python 3.12
ARG PYTHON_VERSION=""

FROM ghcr.io/astral-sh/uv@sha256:9a23023be68b2ed09750ae636228e903a54a05ea56ed03a934d00fe9fbeded4b AS uv-layer

FROM mirror.gcr.io/ubuntu:${UBUNTU_VERSION} AS base
# Re-declare ARG make it available in the build stage
ARG UBUNTU_VERSION
ARG PYTHON_VERSION

# Install basic tools to build
RUN apt-get update && apt-get install -y \
    software-properties-common \
    && apt-get update && apt-get install -y \
    cmake \
    ninja-build \
    g++-12 \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# Install mpi-ulfm from the tenstorrent repository
RUN set -eux; \
    apt-get update && \
    apt-get install -y -f \
    wget ca-certificates && \
    TMP_DIR="$(mktemp -d)" && \
    DEB_URL="https://github.com/tenstorrent/ompi/releases/download/v5.0.7/openmpi-ulfm_5.0.7-1_amd64.deb" && \
    wget -qO "$TMP_DIR/ompi.deb" "$DEB_URL" && \
    apt-get install -f -y "$TMP_DIR/ompi.deb" && \
    rm -rf "$TMP_DIR" && \
    rm -rf /var/lib/apt/lists/*

#############################################################

FROM base AS basic-ttnn-runtime

ARG UBUNTU_VERSION
ARG PYTHON_VERSION

# Install uv with version pinning (centralized in install-uv.sh)
COPY --from=uv-layer /uv /uvx /usr/local/bin/

ENV UV_PYTHON_INSTALL_DIR="/usr/local/share/uv"

# Auto-detect Python version from Ubuntu version if not explicitly provided
RUN set -e; \
    DETECTED_PYTHON_VERSION="${PYTHON_VERSION}"; \
    if [ -z "${DETECTED_PYTHON_VERSION}" ]; then \
    if [ "${UBUNTU_VERSION}" = "24.04" ]; then \
    DETECTED_PYTHON_VERSION="3.12"; \
    else \
    DETECTED_PYTHON_VERSION="3.10"; \
    fi; \
    fi; \
    echo "Installing Python ${DETECTED_PYTHON_VERSION} for Ubuntu ${UBUNTU_VERSION}"; \
    umask 000 && uv python install "${DETECTED_PYTHON_VERSION}"; \
    echo "${DETECTED_PYTHON_VERSION}" > /tmp/python_version

# Install basic runtime dependencies
RUN apt-get update && apt-get install -y \
    git \
    python3-dev \
    python3-pip \
    && rm -rf /var/lib/apt/lists/*

# Install the SFPI compiler
COPY /install_dependencies.sh /opt/tt_metal_infra/scripts/docker/install_dependencies.sh
COPY /tt_metal/sfpi-info.sh /opt/tt_metal_infra/scripts/docker/sfpi-info.sh
COPY /tt_metal/sfpi-version /opt/tt_metal_infra/scripts/docker/sfpi-version
RUN chmod +x /opt/tt_metal_infra/scripts/docker/install_dependencies.sh
RUN /bin/bash /opt/tt_metal_infra/scripts/docker/install_dependencies.sh --sfpi

# Set up virtual environment using uv
ENV PYTHON_ENV_DIR=/opt/venv

# Set umask 000 to allow all users to write (required for uv pip install at runtime)
# SECURITY NOTE: This enables any user in the container to modify the Python environment.
# This is acceptable for single-user containers but should be reconsidered for multi-tenant
# or security-sensitive deployments. Consider using user-specific venvs in those cases.
RUN DETECTED_PYTHON_VERSION=$(cat /tmp/python_version) && \
    umask 000 && uv venv --python "$DETECTED_PYTHON_VERSION" --link-mode copy --managed-python --relocatable "$PYTHON_ENV_DIR"

# Ensure the virtual environment is used for all Python-related commands
ENV PATH="$PYTHON_ENV_DIR/bin:$PATH"
ENV VIRTUAL_ENV="$PYTHON_ENV_DIR"

# Ensure the virtual environment is activated on shell startup
RUN echo "source $PYTHON_ENV_DIR/bin/activate" >> /etc/bash.bashrc

# Add PyTorch CPU wheels to pip config
RUN mkdir -p /etc && \
    echo "[global]\nextra-index-url = https://download.pytorch.org/whl/cpu" > /etc/pip.conf
